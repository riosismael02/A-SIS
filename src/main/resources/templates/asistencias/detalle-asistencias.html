<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head('Empleados - A-SIS')"><link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon"/></head>
<script th:src="@{/js/busqueda-dinamica.js}"></script>

<body>

<div th:replace="fragments/header :: body"></div>
<main class="flex-fill">
    <div class="container">
        <div class="bloque-elevado px-5 py-4 mt-container">

            <!-- Título con íconos -->
            <div class="d-flex align-items-center mb-4">
                <a th:href="@{/}" class="me-3 color-iconos d-flex align-items-center" title="Volver al inicio">
                    <i class="bi bi-arrow-left-circle me-1 fs-5"></i>
                    <i class="bi bi-house-door-fill fs-5"></i>
                </a>
                <h4 class="mb-0 text-h">Detalle de Asistencia por Empleado</h4>
            </div>

            <!-- Formulario -->
            <form method="get" th:action="@{/asistencias/detalle}"
                  class="form-inline-strict d-flex flex-wrap gap-3 align-items-end justify-content-between mb-4">

                <!-- BLOQUE 1: Autocompletado -->
                <div class="form-group d-flex flex-column position-relative flex-grow-1" style="min-width: 250px;">
                    <label for="empleado" class="form-label">Empleado</label>
                    <input type="text" id="empleado" name="empleado" class="form-control"
                           placeholder="Buscar por apellido, nombre o DNI" autocomplete="off">
                    <input type="hidden" id="dni" name="dni">
                    <div id="sugerencias" class="list-group position-absolute w-100 z-3"
                         style="top: 100%; max-height: 200px; overflow-y: auto;"></div>
                </div>

                <!-- BLOQUE 2: Desde y Hasta -->
                <div class="form-group d-flex flex-column flex-grow-1" style="min-width: 250px;">
                    <label class="form-label">Rango de fechas (Desde - Hasta)</label>
                    <div class="d-flex gap-2">
                        <input type="date" name="desde" id="desde" th:value="${desde}" class="form-control"/>
                        <input type="date" name="hasta" id="hasta" th:value="${hasta}" class="form-control"/>
                    </div>
                </div>

                <!-- BLOQUE 3: Botón -->
                <div class="form-group flex-grow-0">
                    <button type="submit" class="btn-action mt-sm-3">
                        <i class="bi bi-search me-1"></i> Buscar
                    </button>
                </div>
            </form>

            <!-- Contenido si hay datos -->
            <div th:if="${detalle != null}">
                <h5 class="mb-3 text-h"
                    th:text="'Detalle de: ' + ${empleado.nombre} + ' ' + ${empleado.apellido} + ' (DNI: ' + ${empleado.dni} + ')'">
                </h5>


                <!-- Resumen -->
                <div class="info-box mb-4">
                    <ul class="mb-0">
                        <li><strong>Total horas trabajadas:</strong>
                            <span th:text="${#numbers.formatDecimal(totalHoras ?: 0.0, 1, 1) + ' h'}"></span></li>
                        <li><strong>Horas normales:</strong>
                            <span th:text="${#numbers.formatDecimal(totalNormales ?: 0.0, 1, 1) + ' h'}"></span></li>
                        <li><strong>Horas extra:</strong>
                            <span th:text="${#numbers.formatDecimal(totalExtras ?: 0.0, 1, 1) + ' h'}"></span></li>
                        <li><strong>Horas fin de semana y feriados:</strong>
                            <span th:text="${#numbers.formatDecimal(totalFinde ?: 0.0, 1, 1) + ' h'}"></span></li>
                        <li><strong>Ausencias:</strong>
                            <span th:text="${totalAusencias ?: 0}"></span></li>
                        <li><strong>Llegadas tarde:</strong>
                            <span th:text="${totalLlegadasTarde ?: 0}"></span></li>
                        <li><strong>Días trabajados:</strong>
                            <span th:text="${diasTrabajados ?: 0}"></span></li>
                    </ul>
                </div>


                <!-- Tabla -->
                <table class="table table-bordered table-hover table-excel">
                    <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Día</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Estado</th>
                        <th>Tipo de Hora</th>
                        <th>Horas Trabajadas</th>
                        <th>Llegada tarde</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="d, iterStat : ${detalle}"
                        th:with="esPrimeraFilaDelDia=${iterStat.index == 0 or d.fechaFormateada != detalle[iterStat.index - 1].fechaFormateada},
         rowClass=${(d != null) ?
            (d.ausente ? 'ausente' :
            (d.marcaIncompleta ? 'incompleto' :
            (d.horasJustificadasDia > 0 and d.horasRealesDia == 0 ? 'justificada' :
            (d.horasJustificadasDia > 0 and d.horasRealesDia > 0 ? 'extra' :
            (d.esFeriado ? 'feriado' :
            (d.esFinDeSemana ? 'finde' : 'normal')))))) : 'normal'}"
                        th:class="${rowClass} + ' clickable-row'"
                        th:data-dni="${d.dni}"
                        th:data-fecha="${d.fechaFormateada != null ? #strings.substring(d.fechaFormateada, 6, 10) + '-' + #strings.substring(d.fechaFormateada, 3, 5) + '-' + #strings.substring(d.fechaFormateada, 0, 2) : ''}"
                        onclick="handleRowClick(this)"
                        style="cursor: pointer;"
                        role="button">

                        <!-- Fecha (solo en la primera fila del día) -->
                        <td th:text="${esPrimeraFilaDelDia} ? ${d.fechaFormateada} : ''"></td>

                        <!-- Día (solo en la primera fila del día) -->
                        <td th:text="${esPrimeraFilaDelDia} ? ${d.nombreDia} : ''"></td>

                        <!-- Entrada -->
                        <td th:text="${d.horaEntrada != null ? #temporals.format(d.horaEntrada, 'HH:mm') : '-'}"></td>

                        <!-- Salida -->
                        <td th:text="${d.horaSalida != null ? #temporals.format(d.horaSalida, 'HH:mm') : '-'}"></td>

                        <!-- Estado -->
                        <td>
            <span th:if="${d.marcaIncompleta}" class="badge bg-danger">
                <span th:text="${d.tipoIncompleto == 'FALTA_ENTRADA' ? 'Incompleto' :
                              (d.tipoIncompleto == 'FALTA_SALIDA' ? 'Incompleto' : 'Registro inválido')}"></span>
            </span>
                            <span th:unless="${d.marcaIncompleta}" class="badge bg-success">Completo</span>
                        </td>

                        <!-- Tipo de hora -->

                        <td>
                            <span th:if="${d.ausente}">-</span>
                            <span th:if="${d.marcaIncompleta}">-</span>
                            <span th:if="${!d.ausente and !d.marcaIncompleta}">
        <span th:switch="${d.tipoHora}">
            <!-- Caso normal -->
            <span th:case="'NORMAL'" class="badge bg-primary">Normal</span>

            <!-- Caso extra puro (solo horas extra sin cumplir horario normal) -->
            <span th:case="'EXTRA'" class="badge bg-danger">Extra</span>

            <!-- Caso mixto (cumplió horario normal + horas extra) -->
            <span th:case="'MIXTO'" class="badge bg-warning text-dark">Mixto</span>

            <!-- Otros casos -->
            <span th:case="'FIN_SEMANA'" class="badge bg-secondary">Finde o Feriado</span>
            <span th:case="'FERIADO'" class="badge bg-dark">Feriado</span>
            <span th:case="*" class="badge bg-light text-dark">-</span>
        </span>
    </span>
                        </td>

                        <!-- Horas trabajadas -->
                        <td th:text="${d.horasTrabajadas > 0 ? #numbers.formatDecimal(d.horasTrabajadas, 1, 'COMMA', 2, 'POINT') + ' h' : '-'}"></td>

                        <td th:text="${d.llegoTarde} ? ${d.minutosTarde + ' min'} : ''"></td>
                    </tr>
                    </tbody>
                </table>

            </div>

        </div>
    </div>
</main>
<script>
    function handleRowClick(row) {
        const dni = row.getAttribute('data-dni');
        const fecha = row.getAttribute('data-fecha');

        if (dni && fecha) {
            window.location.href = `/asistencias/editar-horario?dni=${dni}&fecha=${fecha}`;
        }
    }
</script>

<div th:replace="fragments/footer :: footer"></div>

</body>
</html>
